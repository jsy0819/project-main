<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì‹œê¸€ ì‘ì„±/ìˆ˜ì •</title>
    <link rel="stylesheet" href="/assets/css/style.css">
    <script src="/assets/js/auth.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="/index.html" class="nav-brand">ğŸš€ MSA Project</a>
            <div class="nav-links">
                <a href="/board/board_list.html" class="nav-link">ê²Œì‹œíŒ</a>
                <a href="/blog/blog_list.html" class="nav-link">ë¸”ë¡œê·¸</a>
            </div>
            <div id="auth-links" class="nav-auth"></div>
        </div>
    </nav>
    <main class="container">
        <div class="form-container">
            <h1 id="form-title">ìƒˆ ê²Œì‹œê¸€ ì‘ì„±</h1>
            <form id="board-post-form">
                <p id="error-message" class="error-message" style="display:none;"></p>
                
                <div id="nickname-group">
                    <label for="nickname">ì‘ì„±ì:</label>
                    <input type="text" id="nickname" name="nickname" required>
                </div>

                <div id="password-group">
                    <label for="password">ë¹„ë°€ë²ˆí˜¸:</label>
                    <input type="password" id="password" name="password" required>
                </div>

                <div>
                    <label for="title">ì œëª©:</label>
                    <input type="text" id="title" name="title" required>
                </div>
                <div>
                    <label for="content">ë‚´ìš©:</label>
                    <textarea id="content" name="content" rows="15" required></textarea>
                </div>
                
                <div>
                    <label for="files">ì²¨ë¶€ íŒŒì¼:</label>
                    <input type="file" id="files" name="files" multiple>
                    <div id="current-files-list">
                        </div>
                </div>

                <button type="submit" id="submit-btn" class="btn btn-secondary" style="width: 100%; margin-top: 10px;">ì €ì¥</button>
                <button type="button" class="btn btn-secondary" style="width: 100%; margin-top: 10px; background-color: hsl(115, 89%, 59%);" onclick="window.history.back()">ì·¨ì†Œ</button>
            </form>
        </div>
    </main>
    <script>
        // auth.jsì— ì •ì˜ëœ API_BASE_URLì„ ì‚¬ìš©
        document.addEventListener('DOMContentLoaded', async () => {
            // ë„¤ë¹„ê²Œì´ì…˜ ë°” ë Œë”ë§ (ê²Œì‹œíŒì€ ë¡œê·¸ì¸ ì •ë³´ì™€ ë¬´ê´€í•˜ê²Œ ë Œë”ë§)
            await renderNavbar();

            const form = document.getElementById('board-post-form');
            const titleInput = document.getElementById('title');
            const contentInput = document.getElementById('content');
            const nicknameInput = document.getElementById('nickname');
            const passwordInput = document.getElementById('password');
            const filesInput = document.getElementById('files');
            const formTitle = document.getElementById('form-title');
            const submitBtn = document.getElementById('submit-btn');
            const errorEl = document.getElementById('error-message');
            const nicknameGroup = document.getElementById('nickname-group');
            const passwordGroup = document.getElementById('password-group');
            const currentFilesListDiv = document.getElementById('current-files-list');

            // URLì—ì„œ postIdë¥¼ ê°€ì ¸ì™€ì„œ ìˆ˜ì • ëª¨ë“œì¸ì§€ í™•ì¸
            const urlPathParts = window.location.pathname.split('/');
            const postId = urlPathParts[urlPathParts.length - 1]; // ë§ˆì§€ë§‰ ë¶€ë¶„ì´ ID
            const isEditMode = (urlPathParts[urlPathParts.length - 2] === 'edit') && !isNaN(postId);

            formTitle.innerText = isEditMode ? 'ê²Œì‹œê¸€ ìˆ˜ì •' : 'ìƒˆ ê²Œì‹œê¸€ ì‘ì„±';
            submitBtn.innerText = isEditMode ? 'ìˆ˜ì • ì™„ë£Œ' : 'ì €ì¥';

            if (isEditMode) {
                // ìˆ˜ì • ëª¨ë“œ: ë‹‰ë„¤ì„ í•„ë“œëŠ” ë¹„í™œì„±í™” ë˜ëŠ” ìˆ¨ê¹€, ë¹„ë°€ë²ˆí˜¸ëŠ” ìˆ˜ì •/ì‚­ì œ ì‹œì—ë§Œ ì‚¬ìš©
                nicknameInput.disabled = true; // ë‹‰ë„¤ì„ ìˆ˜ì • ë¶ˆê°€
                // passwordInputì€ ì œì¶œ ì‹œì—ë§Œ í•„ìš”í•˜ë¯€ë¡œ, ë¡œë“œ ì‹œì—ëŠ” ë¹„ì›Œë‘¡ë‹ˆë‹¤.
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api/board/posts/${postId}`);
                    if (!response.ok) throw new Error('ê²Œì‹œê¸€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    
                    const post = await response.json();

                    nicknameInput.value = post.nickname;
                    titleInput.value = post.title;
                    contentInput.value = post.content;

                    // ê¸°ì¡´ íŒŒì¼ ëª©ë¡ í‘œì‹œ
                    if (post.files && post.files.length > 0) {
                        currentFilesListDiv.innerHTML = '<p style="margin-top:10px; font-weight:bold;">í˜„ì¬ ì²¨ë¶€ íŒŒì¼:</p>';
                        post.files.forEach(file => {
                            const fileItem = document.createElement('div');
                            fileItem.style.marginBottom = '8px';
                            fileItem.innerHTML = `
                                <a href="/static/board_files/${file.filepath}" target="_blank">${file.filename}</a>
                                <button type="button" class="btn btn-danger btn-sm delete-file-btn" data-file-id="${file.id}">ì‚­ì œ</button>
                            `;
                            currentFilesListDiv.appendChild(fileItem);
                        });

                        // íŒŒì¼ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                        currentFilesListDiv.querySelectorAll('.delete-file-btn').forEach(button => {
                            button.addEventListener('click', async (e) => {
                                const fileIdToDelete = e.target.dataset.file-id;
                                if (confirm('ì •ë§ë¡œ ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë¹„ë°€ë²ˆí˜¸ í™•ì¸ í•„ìš”)')) {
                                    const deletePassword = prompt('íŒŒì¼ ì‚­ì œë¥¼ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:');
                                    if (!deletePassword) {
                                        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. íŒŒì¼ ì‚­ì œë¥¼ ì·¨ì†Œí•©ë‹ˆë‹¤.');
                                        return;
                                    }
                                    try {
                                        const delResponse = await fetch(`${API_BASE_URL}/api/board/files/${fileIdToDelete}`, {
                                            method: 'DELETE',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ password: deletePassword }),
                                            credentials: 'include'
                                        });
                                        if (delResponse.ok) {
                                            alert('íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                                            e.target.closest('div').remove(); // UIì—ì„œ íŒŒì¼ í•­ëª© ì œê±°
                                        } else {
                                            const errorData = await delResponse.json();
                                            alert(`íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨: ${errorData.detail || delResponse.statusText}`);
                                        }
                                    } catch (err) {
                                        console.error('íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', err);
                                        alert('íŒŒì¼ ì‚­ì œ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                                    }
                                }
                            });
                        });
                    }

                } catch(error) {
                    errorEl.innerText = error.message;
                    errorEl.style.display = 'block';
                    alert('ê²Œì‹œê¸€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.');
                    window.location.href = '/board_list.html';
                }
            } else {
                // ìƒˆ ê¸€ ì‘ì„± ëª¨ë“œ: ë‹‰ë„¤ì„ê³¼ ë¹„ë°€ë²ˆí˜¸ í•„ë“œ ëª¨ë‘ í™œì„± ìƒíƒœ
                nicknameInput.required = true;
                passwordInput.required = true;
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                errorEl.innerText = '';
                errorEl.style.display = 'none';
                submitBtn.disabled = true;
                submitBtn.innerText = 'ì €ì¥ ì¤‘...';

                const formData = new FormData();
                formData.append('title', titleInput.value);
                formData.append('content', contentInput.value);
                formData.append('password', passwordInput.value); // ë¹„ë°€ë²ˆí˜¸ëŠ” í•­ìƒ í•„ìš”

                if (!isEditMode) { // ìƒˆ ê¸€ ì‘ì„± ì‹œì—ë§Œ ë‹‰ë„¤ì„ ì¶”ê°€
                    formData.append('nickname', nicknameInput.value);
                }

                for (let i = 0; i < filesInput.files.length; i++) {
                    formData.append('files', filesInput.files[i]);
                }

                try {
                    let response;
                    if (isEditMode) {
                        // ìˆ˜ì • ì‹œì—ëŠ” PUT/PATCH ìš”ì²­
                        response = await fetch(`${API_BASE_URL}/api/board/posts/${postId}`, {
                            method: 'PUT', // ë˜ëŠ” PATCH
                            body: formData // FormDataë¡œ ë°”ë¡œ ë³´ë‚¼ ìˆ˜ ìˆìŒ
                        });
                    } else {
                        // ìƒˆ ê¸€ ì‘ì„± ì‹œì—ëŠ” POST ìš”ì²­
                        response = await fetch(`${API_BASE_URL}/api/board/posts/`, {
                            method: 'POST',
                            body: formData
                        });
                    }

                    if (response.ok) {
                        const savedPost = await response.json(); // ì‘ë‹µì—ì„œ IDë¥¼ ì–»ê¸° ìœ„í•´
                        alert(isEditMode ? 'ê²Œì‹œê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ê²Œì‹œê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        window.location.href = `/board/view/${savedPost.id}`; // ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
                    } else {
                        const errorData = await response.json();
                        errorEl.textContent = errorData.detail || (isEditMode ? 'ê²Œì‹œê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' : 'ê²Œì‹œê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        errorEl.style.display = 'block';
                    }
                } catch (error) {
                    console.error('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error);
                    errorEl.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì‘ì—…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                    errorEl.style.display = 'block';
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerText = isEditMode ? 'ìˆ˜ì • ì™„ë£Œ' : 'ì €ì¥';
                }
            });
        });
    </script>
</body>
</html>