<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë¸”ë¡œê·¸ ìƒì„¸</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
    <link rel="stylesheet" href="/assets/css/style.css">
    <style>
        /* ì´ í˜ì´ì§€ì—ë§Œ ì ìš©ë˜ëŠ” ì¶”ê°€ ìŠ¤íƒ€ì¼ */
        .post-content { white-space: pre-wrap; line-height: 1.8; }
        .image-gallery { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 1rem; }
        .gallery-img { width: 120px; height: 120px; object-fit: cover; border-radius: 4px; }
        .w3-ul { list-style-type: none; padding: 0; margin: 0; }
        .w3-ul li { padding: 8px 16px; border-bottom: 1px solid #ddd; }
        .w3-ul li:last-child { border-bottom: none; }
    </style>
</head>
<body>
<div class="w3-content">
    <nav class="navbar">
        <div class="container">
            <a href="/index.html" class="nav-brand">ğŸš€ MSA Project</a>
            <div class="nav-links">
                <a href="/board/board_list.html" class="nav-link">ê²Œì‹œíŒ</a>
                <a href="/blog/blog_list.html" class="nav-link">ë¸”ë¡œê·¸</a>
            </div>
            <div id="auth-links" class="nav-auth"></div>
        </div>
    </nav>

    <div class="w3-row">
        <div class="w3-col l8 s12">
            <div id="article-container" class="w3-card-4 w3-margin w3-white">
                </div>
        </div>

        <aside class="w3-col l4">
            <div id="about-me-card"></div>
            <div id="popular-posts-card" class="w3-card-4 w3-margin"></div>
            <div id="tags-card" class="w3-card-4 w3-margin w3-white"></div>
        </aside>
    </div>
</div>

<script src="/assets/js/auth.js"></script>
<script>
    // --- í˜ì´ì§€ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
    const mainContainer = document.querySelector('main');
    const articleContainer = document.getElementById('article-container');
    const aboutMeCard = document.getElementById('about-me-card');
    const popularPostsCard = document.getElementById('popular-posts-card');
    const tagsCard = document.getElementById('tags-card');
    
    // --- URLì—ì„œ ê²Œì‹œë¬¼ ID ê°€ì ¸ì˜¤ê¸° ---
    const articleId = new URLSearchParams(window.location.search).get('id');
    const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };

    // --- ë°ì´í„° ë Œë”ë§ í•¨ìˆ˜ë“¤ ---
    function renderArticle(data, loggedInUser) {
        const { article, author, image_urls } = data;
        const formattedDate = new Date(article.create_at).toLocaleDateString('ko-KR', dateOptions);

        let actionButtons = '';
        if (loggedInUser && loggedInUser.id === article.owner_id) {
            actionButtons = `
                <div style="margin-top: 1rem;">
                    <a href="/blog/post_form.html?type=blog&id=${article.id}" class="btn btn-primary">ìˆ˜ì •</a>
                    <button id="delete-btn" class="btn btn-danger">ì‚­ì œ</button>
                </div>`;
        }

        const mainImage = image_urls.length > 0 ? `<img src="${image_urls[0]}?t={new Date().getTime()}" alt="ëŒ€í‘œ ì´ë¯¸ì§€" style="width:100%">` : '';
        const galleryImages = image_urls.slice(1).map(url => `<img src="${url}?t={new Date().getTime()}" alt="ê°¤ëŸ¬ë¦¬ ì´ë¯¸ì§€" class="gallery-img">`).join('');

        articleContainer.innerHTML = `
            ${mainImage}
            <div class="w3-container">
                <h3><b>${article.title}</b></h3>
                <h5>${author.username || 'Unknown'}, <span class="w3-opacity">${formattedDate}</span></h5>
            </div>
            <div class="w3-container post-content">
                <p>${article.content}</p>
            </div>
            ${galleryImages ? `<div class="w3-container image-gallery">${galleryImages}</div>` : ''}
            <div class="w3-container w3-padding-large">
                <a href="/blog/blog_list.html" class="w3-button w3-border"><b>Â« ëª©ë¡ìœ¼ë¡œ</b></a>
                ${actionButtons}
            </div>
        `;

        if (document.getElementById('delete-btn')) {
            document.getElementById('delete-btn').addEventListener('click', async () => {
                if (confirm('ì •ë§ë¡œ ì´ ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    const response = await fetch(`/api/blog/articles/${article.id}`, { method: 'DELETE', credentials: 'include' });
                    if (response.ok) {
                        alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        window.location.href = '/blog/blog_list.html';
                    } else {
                        alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                }
            });
        }
    }

    function renderAboutMe(user) {
        if (!user) { aboutMeCard.style.display = 'none'; return; }
        aboutMeCard.innerHTML = `
            <div class="w3-card-4 w3-margin w3-white">
                <img src="${user.profile_image_url}" alt="My Photo" style="width:100%">
                <div class="w3-container">
                    <h4><b>${user.username}</b></h4>
                    <p>${user.bio || 'ìê¸°ì†Œê°œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'}</p>
                </div>
            </div>`;
    }

    async function renderPopularPosts() {
        popularPostsCard.innerHTML = `
            <div class="w3-container w3-padding"><h4>Popular Posts</h4></div>
            <p class="w3-container">ë¡œë”© ì¤‘...</p>`;
        try {
            const response = await fetch(`/api/blog/popular-articles`);
            const posts = await response.json();
            const listItems = posts.map(post => `
                <li class="w3-padding-16">
                    <a href="/blog/blog_detail.html?id=${post.id}" style="text-decoration:none; color:inherit;">
                        <span style="font-weight:500;">${post.title}</span><br>
                        <span style="font-size:0.9em;">${post.content.substring(0, 50)}...</span>
                    </a>
                </li>`).join('');
            popularPostsCard.innerHTML = `
                <div class="w3-container w3-padding"><h4>Popular Posts</h4></div>
                <ul class="w3-ul w3-hoverable w3-white">${listItems}</ul>`;
        } catch (error) {
            popularPostsCard.querySelector('p').textContent = 'ì¸ê¸°ê¸€ ë¡œë”© ì‹¤íŒ¨';
        }
    }

    async function renderTags() {
        tagsCard.innerHTML = `<div class="w3-container w3-padding"><h4>Tags</h4></div><div class="w3-container"><p>ë¡œë”© ì¤‘...</p></div>`;
        try {
            const response = await fetch(`/api/blog/tags`);
            const tags = await response.json();
            const tagItems = tags.map(tag => `<span class="w3-tag w3-black w3-margin-bottom" style="margin-right:5px;">${tag}</span>`).join(' ');
            tagsCard.innerHTML = `
                <div class="w3-container w3-padding"><h4>Tags</h4></div>
                <div class="w3-container" style="padding-bottom:16px;">${tagItems}</div>`;
        } catch (error) {
            tagsCard.querySelector('p').textContent = 'íƒœê·¸ ë¡œë”© ì‹¤íŒ¨';
        }
    }

    // --- í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰ë˜ëŠ” ë©”ì¸ í•¨ìˆ˜ ---
    document.addEventListener('DOMContentLoaded', async () => {
        if (!articleId) {
            document.querySelector('main').innerHTML = '<h1>ê²Œì‹œë¬¼ IDê°€ ì—†ìŠµë‹ˆë‹¤.</h1>';
            return;
        }

        // 1. ì‚¬ìš©ì ì •ë³´ë¥¼ í•œ ë²ˆë§Œ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const loggedInUser = await getCurrentUser();
        // 2. ê°€ì ¸ì˜¨ ì •ë³´ë¡œ ë„¤ë¹„ê²Œì´ì…˜ ë°”ë¥¼ ì¦‰ì‹œ ë Œë”ë§í•©ë‹ˆë‹¤.
        renderNavbar(loggedInUser);

        try {
            // 3. ê²Œì‹œë¬¼ ìƒì„¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const response = await fetch(`/api/blog/articles/${articleId}`);
            if (!response.ok) throw new Error('ê²Œì‹œë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            const data = await response.json();
            
            // 4. ê°€ì ¸ì˜¨ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í˜ì´ì§€ì˜ ê° ë¶€ë¶„ì„ ë Œë”ë§í•©ë‹ˆë‹¤.
            renderArticle(data, loggedInUser);
            renderAboutMe(data.author); // ê¸€ì“´ì´ì˜ í”„ë¡œí•„ì„ ì‚¬ì´ë“œë°”ì— í‘œì‹œ
            renderPopularPosts();
            renderTags();
        } catch (error) {
            articleContainer.innerHTML = `<div class="w3-container"><h3 style="color:red;">${error.message}</h3></div>`;
        }
    });
</script>
</body>
</html>