<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‚¬ìš©ì í”„ë¡œí•„</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
    <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body>
<div class="w3-content">
    <nav class="navbar">
        <div class="container">
            <a href="/index.html" class="nav-brand">ğŸš€ MSA Project</a>
            <div class="nav-links">
                <a href="/board_list.html" class="nav-link">ê²Œì‹œíŒ</a>
                <a href="/blog_list.html" class="nav-link">ë¸”ë¡œê·¸</a>
            </div>
            <div id="auth-links" class="nav-auth"></div>
        </div>
    </nav>

    <main class="container">
        <div id="profile-card-container" class="w3-card-4 w3-white w3-margin">
            <div style="padding: 2rem; text-align: center;">ë¡œë”© ì¤‘...</div>
        </div>

        <div id="user-posts-container" class="w3-card-4 w3-white w3-margin">
            <div class="w3-container w3-padding">
                <h3>ì‘ì„±í•œ ê¸€ ëª©ë¡</h3>
            </div>
            <div id="user-posts-list" class="post-list">
                </div>
        </div>
    </main>
</div>

<script src="/assets/js/auth.js"></script>
<script>
    const params = new URLSearchParams(window.location.search);
    const profileCard = document.getElementById('profile-card-container');
    const userPostsList = document.getElementById('user-posts-list');
    const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
    
    // --- í˜ì´ì§€ì˜ ëª¨ë“  ë‚´ìš©ì„ ê·¸ë¦¬ëŠ” ë©”ì¸ í•¨ìˆ˜ ---
    async function renderPage(userId, loggedInUser) {
        // 1. í”„ë¡œí•„ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì™€ì„œ ê·¸ë¦¬ê¸°
        try {
            const profileUserResponse = await fetch(`${API_BASE_URL}/api/users/${userId}`);
            if (!profileUserResponse.ok) throw new Error('ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            
            const profileUser = await profileUserResponse.json();
            renderProfileCard(profileUser, loggedInUser);
        } catch (error) {
            profileCard.innerHTML = `<div class="w3-container"><p style="color:red;">${error.message}</p></div>`;
            return; // í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ê¸€ ëª©ë¡ë„ ë¡œë“œí•˜ì§€ ì•ŠìŒ
        }

        // 2. í•´ë‹¹ ì‚¬ìš©ìê°€ ì‘ì„±í•œ ê¸€ ëª©ë¡ ê°€ì ¸ì™€ì„œ ê·¸ë¦¬ê¸°
        await renderUserPosts(userId);
    }

    // --- í”„ë¡œí•„ ì¹´ë“œ UIë¥¼ ê·¸ë¦¬ëŠ” í•¨ìˆ˜ ---
    function renderProfileCard(profileUser, loggedInUser) {
        let editButton = '';
        if (loggedInUser && loggedInUser.id === profileUser.id) {
            editButton = `<a href="/profile_edit.html" class="btn btn-primary" style="margin-left: auto;">í”„ë¡œí•„ ìˆ˜ì •</a>`;
        }
        profileCard.innerHTML = `
            <div class="profile-header">
                <img src="${profileUser.profile_image_url}" alt="${profileUser.username}" class="profile-image">
                <div class="profile-info">
                    <h1>${profileUser.username}</h1>
                    <p>${profileUser.email}</p>
                </div>
                ${editButton}
            </div>
            <div class="w3-container w3-padding-large">
                <h4>ìê¸°ì†Œê°œ</h4>
                <p>${profileUser.bio || 'ì‘ì„±ëœ ìê¸°ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤.'}</p>
            </div>
        `;
    }

    // --- ì‘ì„±í•œ ê¸€ ëª©ë¡ UIë¥¼ ê·¸ë¦¬ëŠ” í•¨ìˆ˜ ---
    async function renderUserPosts(userId) {
        userPostsList.innerHTML = '<div class="w3-container"><p>ì‘ì„±í•œ ê¸€ ë¡œë”© ì¤‘...</p></div>';
        try {
            const [ boardRes, blogRes ] = await Promise.all([
                fetch(`${API_BASE_URL}/api/board/posts?owner_id=${userId}`),
                fetch(`${API_BASE_URL}/api/blog/articles?owner_id=${userId}`)
            ]);
            const boardData = await boardRes.json();
            const blogData = await blogRes.json();
            
            const allPosts = [
                ...boardData.items.map(p => ({...p, type: 'board', type_ko: 'ê²Œì‹œíŒ'})),
                ...blogData.items.map(a => ({...a, type: 'blog', type_ko: 'ë¸”ë¡œê·¸ ê²Œì‹œê¸€'}))
            ].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            userPostsList.innerHTML = '';
            if (allPosts.length === 0) {
                userPostsList.innerHTML = '<div class="w3-container"><p>ì‘ì„±í•œ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>';
                return;
            }
            allPosts.forEach(post => {
                const link = `/blog/${post.type}_detail.html?id=${post.id}`;
                const formattedDate = new Date(post.created_at).toLocaleDateString('ko-KR', dateOptions);
                userPostsList.innerHTML += `
                    <div class="list-item">
                        <div>
                            <a href="${link}">${post.title}</a>
                            <span class="w3-tag">${post.type_ko}</span>
                        </div>
                        <span class="post-meta">${formattedDate}</span>
                    </div>`;
            });
        } catch (error) {
            userPostsList.innerHTML = '<div class="w3-container" style="color:red;"><p>ì‘ì„±í•œ ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p></div>';
        }
    }

    // â–¼â–¼â–¼ í˜ì´ì§€ê°€ ë¡œë“œë  ë•Œ ì‹¤í–‰ë˜ëŠ” ë©”ì¸ ë¡œì§ (ìˆ˜ì •ë¨) â–¼â–¼â–¼
    document.addEventListener('DOMContentLoaded', async () => {
        let targetUserId = params.get('id'); // URLì—ì„œ id íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
        const loggedInUser = await getCurrentUser();
        
        renderNavbar(loggedInUser); // ë„¤ë¹„ê²Œì´ì…˜ ë°” ë¨¼ì € ë Œë”ë§

        if (!targetUserId) { // 1. URLì— idê°€ ì—†ëŠ” ê²½ìš°
            if (loggedInUser) {
                // 2. ë¡œê·¸ì¸ ìƒíƒœì´ë©´, ë‚´ idë¥¼ ì‚¬ìš©
                targetUserId = loggedInUser.id;
            } else {
                // 3. ë¹„ë¡œê·¸ì¸ ìƒíƒœì´ë©´, ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œí•˜ê³  ì¢…ë£Œ
                document.querySelector('main').innerHTML = `
                    <div class="w3-card-4 w3-white w3-margin w3-container" style="padding: 2rem;">
                        <h2>í”„ë¡œí•„ ë³´ê¸°</h2>
                        <p>ë‹¤ë¥¸ ì‚¬ìš©ìì˜ í”„ë¡œí•„ì„ ë³´ë ¤ë©´ ì£¼ì†Œì°½ì— ?id=ì‚¬ìš©ìID ë¥¼ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.</p>
                        <p>ë‚´ í”„ë¡œí•„ì„ ë³´ë ¤ë©´ <a href="/login.html">ë¡œê·¸ì¸</a> í•´ì£¼ì„¸ìš”.</p>
                    </div>`;
                return;
            }
        }
        
        // ìµœì¢… ê²°ì •ëœ targetUserIdë¡œ í˜ì´ì§€ ë Œë”ë§ í•¨ìˆ˜ í˜¸ì¶œ
        renderPage(targetUserId, loggedInUser);
    });
</script>
</body>
</html>